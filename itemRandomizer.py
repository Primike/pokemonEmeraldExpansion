all_items = [
    "ITEM_MASTER_BALL",
    "ITEM_ULTRA_BALL",
    "ITEM_GREAT_BALL",
    "ITEM_POKE_BALL",
    "ITEM_SAFARI_BALL",
    "ITEM_NET_BALL",
    "ITEM_DIVE_BALL",
    "ITEM_NEST_BALL",
    "ITEM_REPEAT_BALL",
    "ITEM_TIMER_BALL",
    "ITEM_LUXURY_BALL",
    "ITEM_PREMIER_BALL",
    "ITEM_POTION",
    "ITEM_ANTIDOTE",
    "ITEM_BURN_HEAL",
    "ITEM_ICE_HEAL",
    "ITEM_AWAKENING",
    "ITEM_PARALYZE_HEAL",
    "ITEM_FULL_RESTORE",
    "ITEM_MAX_POTION",
    "ITEM_HYPER_POTION",
    "ITEM_SUPER_POTION",
    "ITEM_FULL_HEAL",
    "ITEM_REVIVE",
    "ITEM_MAX_REVIVE",
    "ITEM_FRESH_WATER",
    "ITEM_SODA_POP",
    "ITEM_LEMONADE",
    "ITEM_MOOMOO_MILK",
    "ITEM_ENERGY_POWDER",
    "ITEM_ENERGY_ROOT",
    "ITEM_HEAL_POWDER",
    "ITEM_REVIVAL_HERB",
    "ITEM_ETHER",
    "ITEM_MAX_ETHER",
    "ITEM_ELIXIR",
    "ITEM_MAX_ELIXIR",
    "ITEM_LAVA_COOKIE",
    "ITEM_BLUE_FLUTE",
    "ITEM_YELLOW_FLUTE",
    "ITEM_RED_FLUTE",
    "ITEM_BLACK_FLUTE",
    "ITEM_WHITE_FLUTE",
    "ITEM_BERRY_JUICE",
    "ITEM_SACRED_ASH",
    "ITEM_SHOAL_SALT",
    "ITEM_SHOAL_SHELL",
    "ITEM_RED_SHARD",
    "ITEM_BLUE_SHARD",
    "ITEM_YELLOW_SHARD",
    "ITEM_GREEN_SHARD",
    "ITEM_HP_UP",
    "ITEM_PROTEIN",
    "ITEM_IRON",
    "ITEM_CARBOS",
    "ITEM_CALCIUM",
    "ITEM_RARE_CANDY",
    "ITEM_PP_UP",
    "ITEM_ZINC",
    "ITEM_PP_MAX",
    "ITEM_GUARD_SPEC",
    "ITEM_DIRE_HIT",
    "ITEM_X_ATTACK",
    "ITEM_X_DEFEND",
    "ITEM_X_SPEED",
    "ITEM_X_ACCURACY",
    "ITEM_X_SPECIAL",
    "ITEM_POKE_DOLL",
    "ITEM_FLUFFY_TAIL",
    "ITEM_SUPER_REPEL",
    "ITEM_MAX_REPEL",
    "ITEM_ESCAPE_ROPE",
    "ITEM_REPEL",
    "ITEM_SUN_STONE",
    "ITEM_MOON_STONE",
    "ITEM_FIRE_STONE",
    "ITEM_THUNDER_STONE",
    "ITEM_WATER_STONE",
    "ITEM_LEAF_STONE",
    "ITEM_TINY_MUSHROOM",
    "ITEM_BIG_MUSHROOM",
    "ITEM_PEARL",
    "ITEM_BIG_PEARL",
    "ITEM_STARDUST",
    "ITEM_STAR_PIECE",
    "ITEM_NUGGET",
    "ITEM_HEART_SCALE",
    "ITEM_ORANGE_MAIL",
    "ITEM_HARBOR_MAIL",
    "ITEM_GLITTER_MAIL",
    "ITEM_MECH_MAIL",
    "ITEM_WOOD_MAIL",
    "ITEM_WAVE_MAIL",
    "ITEM_BEAD_MAIL",
    "ITEM_SHADOW_MAIL",
    "ITEM_TROPIC_MAIL",
    "ITEM_DREAM_MAIL",
    "ITEM_FAB_MAIL",
    "ITEM_RETRO_MAIL",
    "ITEM_CHERI_BERRY",
    "ITEM_CHESTO_BERRY",
    "ITEM_PECHA_BERRY",
    "ITEM_RAWST_BERRY",
    "ITEM_ASPEAR_BERRY",
    "ITEM_LEPPA_BERRY",
    "ITEM_ORAN_BERRY",
    "ITEM_PERSIM_BERRY",
    "ITEM_LUM_BERRY",
    "ITEM_SITRUS_BERRY",
    "ITEM_FIGY_BERRY",
    "ITEM_WIKI_BERRY",
    "ITEM_MAGO_BERRY",
    "ITEM_AGUAV_BERRY",
    "ITEM_IAPAPA_BERRY",
    "ITEM_RAZZ_BERRY",
    "ITEM_BLUK_BERRY",
    "ITEM_NANAB_BERRY",
    "ITEM_WEPEAR_BERRY",
    "ITEM_PINAP_BERRY",
    "ITEM_POMEG_BERRY",
    "ITEM_KELPSY_BERRY",
    "ITEM_QUALOT_BERRY",
    "ITEM_HONDEW_BERRY",
    "ITEM_GREPA_BERRY",
    "ITEM_TAMATO_BERRY",
    "ITEM_CORNN_BERRY",
    "ITEM_MAGOST_BERRY",
    "ITEM_RABUTA_BERRY",
    "ITEM_NOMEL_BERRY",
    "ITEM_SPELON_BERRY",
    "ITEM_PAMTRE_BERRY",
    "ITEM_WATMEL_BERRY",
    "ITEM_DURIN_BERRY",
    "ITEM_BELUE_BERRY",
    "ITEM_LIECHI_BERRY",
    "ITEM_GANLON_BERRY",
    "ITEM_SALAC_BERRY",
    "ITEM_PETAYA_BERRY",
    "ITEM_APICOT_BERRY",
    "ITEM_LANSAT_BERRY",
    "ITEM_STARF_BERRY",
    "ITEM_ENIGMA_BERRY",
    "ITEM_BRIGHT_POWDER",
    "ITEM_WHITE_HERB",
    "ITEM_MACHO_BRACE",
    "ITEM_EXP_SHARE",
    "ITEM_QUICK_CLAW",
    "ITEM_SOOTHE_BELL",
    "ITEM_MENTAL_HERB",
    "ITEM_CHOICE_BAND",
    "ITEM_KINGS_ROCK",
    "ITEM_SILVER_POWDER",
    "ITEM_AMULET_COIN",
    "ITEM_CLEANSE_TAG",
    "ITEM_SOUL_DEW",
    "ITEM_DEEP_SEA_TOOTH",
    "ITEM_DEEP_SEA_SCALE",
    "ITEM_SMOKE_BALL",
    "ITEM_EVERSTONE",
    "ITEM_FOCUS_BAND",
    "ITEM_LUCKY_EGG",
    "ITEM_SCOPE_LENS",
    "ITEM_METAL_COAT",
    "ITEM_LEFTOVERS",
    "ITEM_DRAGON_SCALE",
    "ITEM_LIGHT_BALL",
    "ITEM_SOFT_SAND",
    "ITEM_HARD_STONE",
    "ITEM_MIRACLE_SEED",
    "ITEM_BLACK_GLASSES",
    "ITEM_BLACK_BELT",
    "ITEM_MAGNET",
    "ITEM_MYSTIC_WATER",
    "ITEM_SHARP_BEAK",
    "ITEM_POISON_BARB",
    "ITEM_NEVER_MELT_ICE",
    "ITEM_SPELL_TAG",
    "ITEM_TWISTED_SPOON",
    "ITEM_CHARCOAL",
    "ITEM_DRAGON_FANG",
    "ITEM_SILK_SCARF",
    "ITEM_UP_GRADE",
    "ITEM_SHELL_BELL",
    "ITEM_SEA_INCENSE",
    "ITEM_LAX_INCENSE",
    "ITEM_LUCKY_PUNCH",
    "ITEM_METAL_POWDER",
    "ITEM_THICK_CLUB",
    "ITEM_STICK",
    "ITEM_RED_SCARF",
    "ITEM_BLUE_SCARF",
    "ITEM_PINK_SCARF",
    "ITEM_GREEN_SCARF",
    "ITEM_YELLOW_SCARF"
]

tm_items = [
    "ITEM_TM01",
    "ITEM_TM02",
    "ITEM_TM03",
    "ITEM_TM04",
    "ITEM_TM05",
    "ITEM_TM06",
    "ITEM_TM07",
    "ITEM_TM08",
    "ITEM_TM09",
    "ITEM_TM10",
    "ITEM_TM11",
    "ITEM_TM12",
    "ITEM_TM13",
    "ITEM_TM14",
    "ITEM_TM15",
    "ITEM_TM16",
    "ITEM_TM17",
    "ITEM_TM18",
    "ITEM_TM19",
    "ITEM_TM20",
    "ITEM_TM21",
    "ITEM_TM22",
    "ITEM_TM23",
    "ITEM_TM24",
    "ITEM_TM25",
    "ITEM_TM26",
    "ITEM_TM27",
    "ITEM_TM28",
    "ITEM_TM29",
    "ITEM_TM30",
    "ITEM_TM31",
    "ITEM_TM32",
    "ITEM_TM33",
    "ITEM_TM34",
    "ITEM_TM35",
    "ITEM_TM36",
    "ITEM_TM37",
    "ITEM_TM38",
    "ITEM_TM39",
    "ITEM_TM40",
    "ITEM_TM41",
    "ITEM_TM42",
    "ITEM_TM43",
    "ITEM_TM44",
    "ITEM_TM45",
    "ITEM_TM46",
    "ITEM_TM47",
    "ITEM_TM48",
    "ITEM_TM49",
    "ITEM_TM50"
]

import os
import json
import random
import logging
import re

# --- Configuration ---
ROOT_DIR = 'data/maps'
JSON_FILENAME = 'map.json'
file_path = "data/scripts/item_ball_scripts.inc"

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Sanity Checks ---
if not tm_items:
    print("Error: tm_items list is empty. Cannot proceed.")
    exit()
if not all_items:
    print("Error: all_items list is empty. Cannot proceed.")
    exit()

# --- Processing Logic for item_ball_scripts.inc ---
def process_item_ball_scripts(file_path):
    modified_lines = []
    items_replaced = 0
    items_not_replaced = []

    finditem_regex = re.compile(r"^\s*finditem\s+(ITEM_[A-Z0-9_]+)\s*$")

    if not os.path.exists(file_path):
        print(f"Error: The file '{file_path}' was not found.")
        exit()

    with open(file_path, 'r', encoding='utf-8') as f_in:
        lines = f_in.readlines()

    for line in lines:
        match = finditem_regex.match(line.strip())
        if match:
            original_item = match.group(1)
            new_item = None

            if original_item in all_items or original_item in tm_items:
                if original_item.startswith("ITEM_TM"):
                    new_item = random.choice(tm_items)
                else:
                    new_item = random.choice(all_items)

                if new_item and new_item != original_item:
                    modified_line = f"\tfinditem {new_item}\n"
                    modified_lines.append(modified_line)
                    items_replaced += 1
                else:
                    modified_lines.append(line)
            else:
                items_not_replaced.append(original_item)
                modified_lines.append(line)
        else:
            modified_lines.append(line)

    with open(file_path, 'w', encoding='utf-8') as f_out:
        f_out.writelines(modified_lines)

    print(f"Total items replaced: {items_replaced}")
    print(f"Items not replaced ({len(items_not_replaced)}): {items_not_replaced}")

# --- Processing Logic for JSON files ---
def process_json_files(root_directory, filename_to_find):
    processed_files = 0
    modified_files = 0
    items_replaced_count = 0
    items_not_replaced = []

    for subdir, _, files in os.walk(root_directory):
        if filename_to_find in files:
            json_path = os.path.join(subdir, filename_to_find)
            processed_files += 1
            file_was_modified = False

            try:
                with open(json_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)

                if 'bg_events' in data and isinstance(data['bg_events'], list):
                    for event in data['bg_events']:
                        if isinstance(event, dict) and event.get('type') == 'hidden_item':
                            original_item = event.get('item')
                            if original_item:
                                new_item = None

                                if original_item in all_items or original_item in tm_items:
                                    if original_item.startswith("TM") or original_item.startswith("HM"):
                                        if tm_items:
                                            new_item = random.choice(tm_items)
                                    else:
                                        if all_items:
                                            new_item = random.choice(all_items)

                                    if new_item and new_item != original_item:
                                        event['item'] = new_item
                                        file_was_modified = True
                                        items_replaced_count += 1
                                else:
                                    items_not_replaced.append(original_item)

                if file_was_modified:
                    with open(json_path, 'w', encoding='utf-8') as f:
                        json.dump(data, f, indent=4)
                    modified_files += 1

            except json.JSONDecodeError as e:
                logging.error(f"Error decoding JSON file {json_path}: {e}")
            except IOError as e:
                logging.error(f"Could not read file {json_path}: {e}")
            except Exception as e:
                logging.error(f"An unexpected error occurred processing {json_path}: {e}")

    logging.info(f"--- Processing Complete ---")
    logging.info(f"Total files scanned: {processed_files}")
    logging.info(f"Total files modified: {modified_files}")
    logging.info(f"Total items replaced: {items_replaced_count}")
    logging.info(f"Items not replaced ({len(items_not_replaced)}): {items_not_replaced}")

# --- Run the script ---
if __name__ == "__main__":
    if not all_items or not tm_items:
        print("!!! WARNING: 'all_items' or 'tm_items' lists are empty or incomplete.")
        exit()

    process_item_ball_scripts(file_path)
    process_json_files(ROOT_DIR, JSON_FILENAME)